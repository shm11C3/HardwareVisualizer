name: "CI"

on:
  pull_request:
    branches:
      - master
      - develop
      - release/**
      - develop-v*
  push:
    branches:
      - develop
      - develop-v*

jobs:
  #
  # Checks to see what changed
  #
  quick-checks:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-deps-changed: ${{ steps.changes.outputs.frontend-deps }}
      backend-deps-changed: ${{ steps.changes.outputs.backend-deps }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check changed files
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'package*.json'
              - 'vite.config.ts'
              - 'tsconfig*.json'
              - '.github/workflows/**'
              - '.github/scripts/**'
            backend:
              - 'src-tauri/**'
              - 'Cargo.*'
              - '.github/workflows/**'
              - '.github/scripts/**'
            frontend-deps:
              - 'package*.json'\
            backend-deps:
              - 'Cargo.*'

  #
  # Backend lint and clippy
  #
  lint-backend:
    needs: quick-checks
    if: needs.quick-checks.outputs.backend-changed == 'true'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ["windows-latest", "ubuntu-22.04"]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: ./.github/actions/setup-linux-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Check Rust formatting
        run: cargo fmt --manifest-path src-tauri/Cargo.toml -- --check

      - name: Check Rust clippy
        run: cargo clippy --manifest-path src-tauri/Cargo.toml -- -D warnings

  #
  # Backend tests
  #
  test-backend:
    needs: quick-checks
    if: needs.quick-checks.outputs.backend-changed == 'true'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ["windows-latest", "ubuntu-22.04"]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: ./.github/actions/setup-linux-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ""

      - name: Run backend tests
        run: cargo test --manifest-path src-tauri/Cargo.toml -- --test-threads=1 --nocapture

  #
  # Build test
  #
  test-build:
    needs: quick-checks
    # When updating npm packages related to tauri, build errors may occur.
    # Therefore, checks should be performed during backend updates and when updating frontend dependencies.
    if: needs.quick-checks.outputs.backend-changed == 'true' || needs.quick-checks.outputs.frontend-deps-changed == 'true'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ["windows-latest", "ubuntu-22.04"]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: ./.github/actions/setup-linux-deps
        with:
          extra-packages: "libfuse2 libappindicator3-dev patchelf"

      - name: Fix linuxdeploy permissions
        if: matrix.platform == 'ubuntu-22.04'
        run: chmod +x ./src-tauri/target/release/bundle/appimage/linuxdeploy-*.AppImage || true

      - name: Unset problematic env vars
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          unset GTK_PATH
          unset LD_LIBRARY_PATH

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ""

      - name: Optimize Windows build environment
        if: matrix.platform == 'windows-latest'
        run: |
          echo "CARGO_INCREMENTAL=0" >> $GITHUB_ENV

      - name: Build with Tauri (CI optimized for PR)
        if: github.event_name == 'pull_request'
        uses: tauri-apps/tauri-action@e834788a94591d81e3ae0bd9ec06366f5afb8994 # v0.5.23
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: -- --profile ci

      - name: Build with Tauri (Release profile for push)
        if: github.event_name != 'pull_request'
        uses: tauri-apps/tauri-action@e834788a94591d81e3ae0bd9ec06366f5afb8994 # v0.5.23
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #
  # Frontend Lint
  #
  lint-frontend:
    needs: quick-checks
    if: needs.quick-checks.outputs.frontend-changed == 'true'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Frontend lint
        run: npm run lint:ci

  #
  # Frontend tests
  #
  test-frontend:
    needs: quick-checks
    if: needs.quick-checks.outputs.frontend-changed == 'true'
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Run frontend tests with coverage
        run: npm run test:unit-cov

      - name: Report coverage
        uses: davelosert/vitest-coverage-report-action@8ab049ff5a2c6e78f78af446329379b318544a1a # v2.8.3
        with:
          json-summary-path: coverage/coverage-summary.json

  #
  # License checks (only on PR)
  #
  license-check-npm:
    needs: quick-checks
    if: github.event_name == 'pull_request' && needs.quick-checks.outputs.frontend-deps-changed == 'true'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Generate licenses.json
        run: npx license-checker --production --json > licenses.json

      - name: Check licenses
        run: node --experimental-strip-types .github/scripts/check-licenses.ts licenses.json

      - name: Extract Apache NOTICE
        run: node --experimental-strip-types .github/scripts/extract-apache-notices.ts licenses.json notices

  license-check-cargo:
    needs: quick-checks
    if: github.event_name == 'pull_request' && needs.quick-checks.outputs.backend-deps-changed == 'true'
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ["windows-latest", "ubuntu-22.04"]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: ./.github/actions/setup-linux-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ""

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Check Rust licenses
        working-directory: src-tauri
        run: cargo deny check licenses
