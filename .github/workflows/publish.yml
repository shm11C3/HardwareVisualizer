name: "Publish"

on:
  push:
    branches:
      - master
      - release/**

# This workflow will trigger on each push to the `release` branch to create or update a GitHub release, build your app, and upload the artifacts to the release.

jobs:
  check-version:
    permissions:
      contents: read
      pull-requests: read

    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.check-version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          install-deps: false

      - name: Check Version
        id: check-version
        uses: shm11C3/tauri-check-release-version@v1.0.4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          owner: shm11C3
          repo: HardwareVisualizer
          tauri_config_path: ./src-tauri/tauri.conf.json
          tag_name_format: v{VERSION}

  publish-tauri:
    needs: check-version
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: ""
            os-name: "windows"
          - platform: "ubuntu-22.04"
            args: ""
            os-name: "linux"

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        uses: ./.github/actions/setup-linux-deps
        with:
          extra-packages: "libfuse2 libappindicator3-dev patchelf"

      - name: Fix linuxdeploy permissions
        if: matrix.platform == 'ubuntu-22.04'
        run: chmod +x ./src-tauri/target/release/bundle/appimage/linuxdeploy-*.AppImage || true

      - name: Unset problematic env vars
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          unset GTK_PATH
          unset LD_LIBRARY_PATH

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          install-deps: false

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: ""

      - name: install frontend dependencies
        run: npm ci # change this to npm, pnpm or bun depending on which one you use.

      - name: Resolve Tauri tool dirs (WixTools314)
        if: ${{ matrix.platform == 'windows-latest' }}
        id: tauri_tools
        shell: pwsh
        run: |
          $wixDir = Join-Path $env:LOCALAPPDATA "tauri\WixTools314"
          "wix_dir=$wixDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "wix_dir=$wixDir"

      - name: Cache WiX Toolset (wix314)
        if: ${{ matrix.platform == 'windows-latest' }}
        uses: actions/cache@v5
        with:
          path: ~\AppData\Local\tauri\WixTools314
          key: wix314-${{ runner.os }}-wix3141rtm-v1

      - name: Preload WiX Toolset (wix314)
        if: ${{ matrix.platform == 'windows-latest' }}
        shell: pwsh
        run: |
          $wixDir = "${{ steps.tauri_tools.outputs.wix_dir }}"
          New-Item -ItemType Directory -Force -Path $wixDir | Out-Null

          $candle = Join-Path $wixDir "candle.exe"
          $light  = Join-Path $wixDir "light.exe"

          if ((Test-Path $candle) -and (Test-Path $light)) {
            Write-Host "WiX already present: $wixDir"
            exit 0
          }

          $url = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip"
          $zip = Join-Path $env:RUNNER_TEMP "wix314-binaries.zip"
          $tmp = Join-Path $env:RUNNER_TEMP "wix314-extract"

          Remove-Item -Recurse -Force $tmp -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path $tmp | Out-Null

          Write-Host "Downloading WiX: $url"
          curl.exe -L --retry 6 --retry-all-errors --connect-timeout 20 --max-time 600 -o $zip $url
          Expand-Archive -Path $zip -DestinationPath $tmp -Force

          $found = Get-ChildItem -Path $tmp -Recurse -Filter "candle.exe" | Select-Object -First 1
          if (-not $found) { throw "candle.exe not found in extracted archive. Download might be corrupted." }

          $root = $found.Directory.FullName
          Write-Host "Detected WiX root: $root"

          Copy-Item -Path (Join-Path $root "*") -Destination $wixDir -Recurse -Force

          if (-not (Test-Path $candle)) { throw "candle.exe still missing at $wixDir (structure mismatch)" }
          if (-not (Test-Path $light))  { throw "light.exe still missing at $wixDir (structure mismatch)" }

          Write-Host "WiX prepared at: $wixDir"
          Get-ChildItem $wixDir | Select-Object Name | Format-Table -AutoSize

      - uses: tauri-apps/tauri-action@19b93bb55601e3e373a93cfb6eb4242e45f5af20 # v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__ # the action automatically replaces \_\_VERSION\_\_ with the app version.
          releaseName: "v__VERSION__"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      - name: Upload THIRD_PARTY_NOTICES.md
        run: |
          mv ./tmp/THIRD_PARTY_NOTICES.md ./tmp/THIRD_PARTY_NOTICES_${{ matrix.os-name }}.md
          gh release upload "v${{ needs.check-version.outputs.version }}" ./tmp/THIRD_PARTY_NOTICES_${{ matrix.os-name }}.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
